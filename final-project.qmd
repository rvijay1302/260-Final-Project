---
title: "final-project"
format: html
editor: visual
---

```{r}
library(readr)
library(tidyverse)
library(knitr)
library(kableExtra)
data <- load("data/excessmort_clean.RData")
nytimes <- load ("data/nytimes_table.RData")
library(excessmort)
daily_counts <- puerto_rico_counts %>% filter(between(year(date), 2015, 2018))
tmp <- daily_counts |> 
  filter(date > make_date(2015, 1, 1),date < make_date(2017, 10, 20), date <= max(date) - days(45) ) |> 
  group_by(date) %>%
  summarise(deaths = sum(outcome, na.rm = TRUE)) 
tmp %>%
  ggplot(aes(yday(date), deaths, color = date < make_date(2017, 9, 20))) +  
  geom_point(show.legend = FALSE) +
  theme_bw() +
  labs(
    title = "Deaths extracted from excess mort package", 
    subtitle = "Data for days after the hurricane are shown in red", 
    x = "Day of the Year", 
    y = "Deaths"
  )
```

```{r}
tmp2 <- all_data %>% mutate(date = floor_date(date, unit = "week", week_start = 3)) |> 
  filter(date <= max(date) - days(45)) %>% 
  group_by(date) |>
  summarize(deaths = sum(deaths), 
            n = n(), .groups = "drop") |>
  filter(n == 7) |>
  select(-n) |>
  mutate(week = epiweek(date)) |>
  mutate(day = difftime(date, min(date), units = "day"),
         week = as.factor(week)) %>%   mutate(dataset= "NY times") 
weekly_edited <- tmp %>% mutate(date = floor_date(date, unit = "week", week_start = 3)) |>
  group_by(date) |>
  summarize(deaths = sum(deaths), 
            n = n(), .groups = "drop") |>
  filter(n == 7) |>
  select(-n) |>
  mutate(week = epiweek(date)) |>
  mutate(day = difftime(date, min(date), units = "day"),
         week = as.factor(week)) %>%  mutate(dataset= "excessmort package")
combined_data <- bind_rows(tmp2,weekly_edited )  


```


Methods

the nytimes was wrangled using pdftools r package, a function was made that took the page number and month name in the pdf as inputs, the algorithm splits the pdf into lines that can be accessed one by one, header was set to the table and a data frame representing each month was the output for this function. further wrangling was done to turn 12 dataframes into one combined dataframe, pivot longer was used to turn the columns for each year into rows, followed by making a date for each row by using the month, day,year columns and removing them from a final dataframe that included the date and number of deaths for each row. deaths were then summed for each week for better visualization.

```{r}
all_data |> ggplot(aes(date, deaths)) + geom_point() + 
  labs(title = "Deaths extracted from PDF shared with NYT", x = "Date", y = "Deaths")
```

After plotting NYtimes scatter plot (see supplementary materials) we can see a drop at the end, which is because it takes time to officially register deaths, it takes 45 days to register the deaths, so the last 45 days were removed. 

Excessmort data was wrangled in two different ways for two different research questions of interest, it was wrangled to include dates between 2002 and 2017 and the dates were rounded to the day of the week when maria made landfall in Peurto Rico, grouped by agegroup and sex, the deaths was summed for all days of the week for each week providing weekly counts. excessmort data was also summarised to sum the deaths across all age groups and both sexes for each week, to be compared to the NY times dataset, filtered to only include dates included in the NYtimes pdf.

Results

```{r}
ggplot(combined_data, aes(x = date, y = deaths, color = dataset)) +
  geom_line() + 
  geom_point() +  # Optional: Add points for clarity
  geom_vline(xintercept = as.Date("2017-09-20"), linetype = "dashed", color = "grey", linewidth = 0.8)+
  labs(title = "Deaths Comparison Over Time",
       x = "Date",
       y = "Deaths") +
  theme_bw()
```

```{r}
diff <- combined_data %>%
  group_by(dataset) %>%
  pivot_wider(names_from = dataset, values_from = deaths) %>%
  mutate(difference = `excessmort package` - `NY times`) %>% 
  filter (difference > 8) %>%  select(-c(week,day)) %>% 
  rename (Date = date, `Excessmort package` =`excessmort package`, Difference=difference) %>% 
  kable () %>% 
  kable_styling() %>%
  row_spec(0, align = "c")  

  
diff
```

The nytimes data seemed mostly similar to the excessmort data, differences were seen on certain dates, the largest difference was on the week of 2016-08-03 with excess deaths counted in the excessmort package, this trend continued for the following three weeks that year with a sum of 162. Another inconsistency was observed for 7 weeks starting in 2017-August-30, the sum of total deaths in the 7 weeks is 119 death included in excessmort package but not in the NY times pdf. The line plot shows the increase around SEP-2017 in favor of excessmort package, marked by the vertical grey line.
