---
title: "final-project"
format: html
editor: visual
---

```{r}
library(tidyverse)
library(knitr)
load("data/excessmort_clean.RData")
```

## Methods

Exploratory data analysis was carried out on data filtered to include only the years 2002 to 2016 to examine and compare the recorded death rates across different age and sex groups (Supplementary materials #). Age groups in our dataset were then combined based on similarities in observed trends in rates. Five age categorizations were created from merging (0-4, 5-24, 25-54, 55-74, 75-Inf). New observed death counts, population counts, and death rates were calculated based on these new age categorizations.

A multivariable linear regression model was fitted to this data, and predicted death count values were generated using this model along with confidence intervals for these predictions. The covariates sex, age_category, days since 01-02-2002, and week were considered in our model. Plots were generated to compare predicted deaths (and their corresponding confidence intervals) and observed deaths (Supplementary Materials #).

Further exploratory data analysis was conducted to examine any periods of excess mortality in our dataset. Death counts were plotted for each week to reveal any periods of time where excess mortality occured. These periods were removed from our dataset, and our linear regression was fit again without these extreme observations.

Our fitted model was then used to estimate excess deaths in 2017. The predicted values were then examined using tables and plots. Particular focus was given to the impact of Hurricane Maria's landfall on September 20th, 2017, and its effect on excess deaths across different age groups and sexes.

## Results

Plotting the date vs. observed rate of death by age group revealed higher death rates in older populations, particularly in the 75-79, 80-84, and 80-Inf age categories (Supplementary materials #). Overall, death rates tended to decrease in younger age groups. However, the 0-4 age group is an exception, displaying unusually high variability compared to other young age groups (Supplementary materials #). Trends in sex differences revealed that males tend to have higher death rates than females throughout our dataset (Supplementary materials #).

A final model was chosen to accurately represent the relationship of our selected covariates:

$$
\begin{align}
\text{rate} &= \beta_0 + \beta_1 \cdot \text{sex} + \beta_2 \cdot \text{age_category} \nonumber \\
            &\quad + \beta_3 \cdot \text{day} + \beta_4 \cdot \text{week} \nonumber \\
            &\quad + \beta_5 \cdot (\text{age_category} \times \text{sex}) \nonumber \\
            &\quad + \beta_6 \cdot (\text{age_category} \times \text{week}) + \epsilon
\end{align}
$$

Notably, the interaction terms age_category X sex and age_category X week were found to be significant in our model based on p-values for the beta coefficients and visual inspection of the observed vs. predicted deaths plot (supplementary material #).

The expected death counts generated by this model revealed a noticeable downward trend in expected deaths in the 0-4, 5-24, and 25-54 age groups (supplementary material #). The trend in the 55-74 age group stayed relatively consistent, and there is a noticeable upward trend in the 75-Inf age group. Death counts were also noticeably higher in males across all age groups. The observed vs. predicted deaths plot shows well fitting expected counts across all age groups, and in particular the 55-74 and 75-Inf age groups. It's important to highlight that the model does not account for all the variability seen across the data's age groups, as indicated by this plot.

```{r}
weekly_counts_combined <- weekly_counts |>
  filter(year(date) < 2017) |>
  mutate(age_category = case_when(
    agegroup %in% c("75-79", "80-84", "85-Inf") ~ "75-inf",
    agegroup %in% c("55-59", "60-64", "65-69", "70-74") ~ "55-74",
    agegroup %in% c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54") ~ "25-54",
    agegroup %in% c("5-9", "10-14", "15-19", "20-24") ~ "5-24",
    agegroup == "0-4" ~ "0-4"
  )) |>
  group_by(date, sex, age_category, week, day) |>
  summarize(
    outcome = sum(outcome),
    population = sum(population),
    rate = sum(outcome) / sum(population),
    .groups = "drop"
  )

fit <- lm(rate ~ sex + age_category + day + week + age_category:sex + age_category:week, data = weekly_counts_combined)

summary(fit)

predictions1 <- predict(fit, newdata = weekly_counts_combined, se.fit = TRUE)

weekly_counts_combined <- weekly_counts_combined %>% 
  mutate(
    exp = predictions1$fit*population,
    se = predictions1$se.fit*population,
    sigma = sd(fit$resid)*population,
    excess = outcome - exp,
    lower = exp - 1.96 * se,
    upper = exp + 1.96 * se,
  )

weekly_counts_combined %>%
  ggplot(aes(x = date)) +
  geom_line(aes(y = outcome, color = sex), alpha = 0.5) +
  geom_line(aes(y = exp, color = sex), linetype = "dashed") +
  facet_wrap(~ age_category, scales = "free_y", ncol = 1) +
  labs(
    title = "Observed vs Predicted Deaths by Age Category and Sex",
    x = "Date",
    y = "Deaths",
    color = "Sex"
  ) +
  theme_minimal() +
  scale_color_brewer(palette = "Set1") +
  theme(legend.position = "bottom") +
  guides(color = guide_legend(override.aes = list(linetype = c("solid", "dashed")))) +
  annotate("text", x = min(weekly_counts_combined$date), y = Inf, 
           hjust = 0, vjust = 1, label = "Solid: Observed\nDashed: Predicted", 
           size = 3)
```

Three periods of excess mortality were identified based on our exploratory data analysis, November 2004 - January 2005, August 2014 - February 2015, and November 2016 - December 2016. Predictions for deaths counts were generated againm using our dataset from 2002-2016, without these observations using the same model structure.

This newly fitted model was then used to predict excess deaths in 2017. The results of this analysis indicated a very noticeable increase in excess deaths starting on the week of September 20th, 2017 (supplementary material #). Further inspection of this prediction indicated that mainly occurred in the 55-75 and 75-Inf age groups, while the 0-4, 5-24, and 25-54 age groups saw little to no increase in excess mortality (supplementary material #). Furthermore, excess mortality appeared to rise more significantly among males than females across all age groups.

```{r}
weekly_counts_combined_1 <- weekly_counts_combined |>
  filter(
    !(between(date, make_date(2004, 11, 1), make_date(2005, 1, 31)) |
      between(date, make_date(2014, 8, 1), make_date(2015, 2, 28)) |
      between(date, make_date(2016, 11, 1), make_date(2016, 12, 31)))
  )

fit1 <- lm(rate ~ sex + age_category + day + week + age_category:sex + age_category:week, data = weekly_counts_combined_1)

weekly_counts_with_2017 <- weekly_counts |>
  mutate(age_category = case_when(
    agegroup %in% c("75-79", "80-84", "85-Inf") ~ "75-inf",
    agegroup %in% c("55-59", "60-64", "65-69", "70-74") ~ "55-74",
    agegroup %in% c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54") ~ "25-54",
    agegroup %in% c("5-9", "10-14", "15-19", "20-24") ~ "5-24",
    agegroup == "0-4" ~ "0-4"
  )) |>
  group_by(date, sex, age_category, week, day) |>
  summarize(
    outcome = sum(outcome),
    population = sum(population),
    rate = sum(outcome) / sum(population),
    .groups = "drop"
  )

predictions2 <- predict(fit1, newdata = weekly_counts_with_2017, se.fit = TRUE)

weekly_counts_with_2017 <- weekly_counts_with_2017 %>% 
  mutate(
    exp = predictions2$fit*population,
    se = predictions2$se.fit*population,
    sigma = sd(fit$resid)*population,
    excess = outcome - exp,
    lower = exp - 1.96 * se,
    upper = exp + 1.96 * se,
  )

weekly_counts_with_2017 |>
  filter(between(date, make_date(2017, 7, 31), make_date(2017, 12, 31))) |>
  group_by(date) |>
  summarize(outcome = round(sum(outcome)), 
            expected = round(sum(exp)), 
            excess = round(sum(excess))) |>
  kable()
```

```{r}
weekly_counts_with_2017 |>
  filter(year(date) == 2017) |>
  ggplot(aes(date, excess)) +
  geom_point() +
  geom_hline(yintercept = 0, lty = 2, color = "grey") +
  geom_errorbar(aes(ymin = excess - 1.96*se, ymax = excess + 1.96*se)) +
  facet_grid(sex ~ age_category, scales = "free_y") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Date", y = "Excess", title = "Excess by Sex and Age Category")
```
